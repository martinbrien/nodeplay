- name: grab existing LinodeID ## use uri play instead of curl 
  shell: curl -u u:{{LNDKEY}} https://api.linode.com/?api_action=linode.list | jq '.DATA[] | select(.LABEL | contains("{{hostname}}"))' | jq -r .LINODEID
  register: OLD_ID

- debug: msg="{{OLD_ID.stdout}}"

- name: delete existing linode ## use api and not module!
  local_action:
   module: linode
   name: "{{ hostname}}"
   api_key: "{{ LNDKEY }}"
   linode_id: "{{ OLD_ID.stdout }}"
   state: absent
  when: OLD_ID.stdout != "" 

- name: make new linode
  local_action:
   module: linode
   api_key: "{{ LNDKEY }}"
   plan: 1
   name: "{{ hostname }}"
   datacenter: 7
   distribution: 148   # arch 148
   password: "{{ LNDPW }}"
   ssh_pub_key: "{{ lookup('url', 'https://8n1.org/raw/14659/e332') }}"
   swap: 768
   wait: yes
   wait_timeout: 600
   state: present

- name: grab new LinodeID  
  shell: curl -u u:{{LNDKEY}} https://api.linode.com/?api_action=linode.list | jq '.DATA[] | select(.LABEL | contains("{{hostname}}"))' | jq -r .LINODEID
  register: NEW_ID

- name: grab new IP
  shell: curl -u u:{{LNDKEY}} https://api.linode.com/?api_action=linode.ip.list | jq '.DATA[] | select(.LINODEID=={{NEW_ID.stdout}})' | jq -r .IPADDRESS
  register: NEW_IP

- debug: msg="{{NEW_IP.stdout}}"

- name: update /etc/hosts with new ip
  shell: hostess add {{hostname}} {{NEW_IP.stdout}}
  become: yes

- name: wait for linode to come online after initial creation
  local_action: wait_for host="{{hostname}}" port=22 delay=10 timeout=3600 state=started 

- name: get namesilo id for dns record
  uri:
    url: > 
      https://www.namesilo.com/api/
      dnsListRecords?version=1&
      type=xml&
      key=dfd20803f76a4f1f9b39ed&
      domain=mbrien.net
    return_content: yes
  register: result

- debug: msg="{{result.content[185:217]}}" 

- name: change dns record for mbrien.new
  uri:
    url: > 
      https://www.namesilo.com/api/
      dnsUpdateRecord?version=1&
      type=xml&
      key=dfd20803f76a4f1f9b39ed&
      domain=mbrien.net&
      rrid={{result.content[185:217]}}&
      rrhost=www&
      rrvalue={{NEW_IP.stdout}}
    return_content: yes

- name: change dns record for mbrien.new
  uri:
    url: >
      https://www.namesilo.com/api/
      dnsUpdateRecord?version=1&
      type=xml&
      key=dfd20803f76a4f1f9b39ed&
      domain=mbrien.net&
      rrid={{result.content[185:217]}}&
      rrhost=git&
      rrvalue={{NEW_IP.stdout}}
    return_content: yes


